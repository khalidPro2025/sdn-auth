server {
    listen 80;
    server_name micro-services.ktech.sn;

    # --- Healthcheck du reverse-proxy Nginx
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy\n";
    }

    # --- oauth2-proxy : UI (sign_in, callback, sign_out)
    location /oauth2/ {
        proxy_pass http://sdn-oauth2-proxy:4180;

        # Garder l’host tel que reçu via Traefik (SNI/Host)
        proxy_set_header Host              $http_host;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        $connection_upgrade;

        add_header Cache-Control "no-store";
    }
       # --- Health custom: mappe /oauth2/health -> /ping de oauth2-proxy
    location = /oauth2/health {
        proxy_pass http://sdn-oauth2-proxy:4180/ping;

        proxy_set_header Host              $http_host;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }

    # --- oauth2-proxy : endpoint interne pour auth_request
    location = /oauth2/auth {
        internal;
        proxy_pass http://sdn-oauth2-proxy:4180;

        proxy_set_header Host              $http_host;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Transmettre le cookie au endpoint interne
        proxy_set_header Cookie            $http_cookie;
        proxy_set_header Content-Length    "";
        proxy_pass_request_body off;

        # Ne pas intercepter les 401 ici (comportement normal si pas loggé)
        proxy_intercept_errors off;
    }

    # --- API Gateway → Backend (protégée par cookie + groupes)
    location /api/ {
        # 1) protège avec oauth2-proxy
        auth_request /oauth2/auth;

        # 2) récupère les entêtes renvoyées par oauth2-proxy
        auth_request_set $user    $upstream_http_x_auth_request_user;
        auth_request_set $email   $upstream_http_x_auth_request_email;
        auth_request_set $groups  $upstream_http_x_auth_request_groups;
        auth_request_set $token   $upstream_http_x_auth_request_access_token;

        # 3) propage vers le backend
        proxy_set_header X-User        $user;
        proxy_set_header X-Email       $email;
        proxy_set_header X-Groups      $groups;
        proxy_set_header Authorization "Bearer $token";

        proxy_pass http://sdn-backend:4000/;

        proxy_set_header Host                 $http_host;
        proxy_set_header X-Forwarded-Host     $host;
        proxy_set_header X-Real-IP            $remote_addr;
        proxy_set_header X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto    $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade              $http_upgrade;
        proxy_set_header Connection           $connection_upgrade;
        proxy_read_timeout 60s;
    }

    # --- User Profile Service (exposé pour tests)
    location /profile/ {
        auth_request /oauth2/auth;
        proxy_set_header X-User   $upstream_http_x_auth_request_user;
        proxy_set_header X-Email  $upstream_http_x_auth_request_email;
        proxy_pass http://user-profile:4100/;

        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
    }

    # --- Front public (SPA)
    location / {
        proxy_pass http://sdn-frontend:80;

        proxy_set_header Host                 $http_host;
        proxy_set_header X-Forwarded-Host     $host;
        proxy_set_header X-Real-IP            $remote_addr;
        proxy_set_header X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto    $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade              $http_upgrade;
        proxy_set_header Connection           $connection_upgrade;
    }
}
